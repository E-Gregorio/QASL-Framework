#!/usr/bin/env node
/**
 * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 * RUN PIPELINE - Ejecuta Pipeline Completo de Testing
 * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 *
 * Ejecuta secuencialmente:
 *   1. E2E Tests (Playwright) โ Reporte Allure HTML
 *   2. API Tests (Newman) โ Reporte HTMLExtra
 *   3. Performance Tests (K6) โ Reporte HTML + Grafana
 *   4. Security Tests (ZAP) โ Reporte HTML Nativo
 *
 * Uso:
 *   node scripts/run-pipeline.mjs [spec] [opciones]
 *
 * Opciones:
 *   --skip-e2e      Saltar E2E (usar captura existente)
 *   --skip-api      Saltar tests API
 *   --skip-k6       Saltar tests Performance
 *   --skip-zap      Saltar tests Security
 *   --vus=N         VUs para K6 (default: 10)
 *   --duration=Ns   Duraciรณn K6 (default: 30s)
 *
 * Ejemplos:
 *   node scripts/run-pipeline.mjs TS-001               # Pipeline completo
 *   node scripts/run-pipeline.mjs --skip-e2e           # Usa captura existente
 *   node scripts/run-pipeline.mjs --skip-zap           # Sin security scan
 *
 * Reportes:
 *   reports/
 *   โโโ e2e/allure-report/    # Allure HTML
 *   โโโ api/                   # Newman HTMLExtra
 *   โโโ k6/                    # K6 HTML + JSON
 *   โโโ zap/                   # ZAP HTML + JSON
 *
 * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 */

import { execSync } from 'child_process';
import path from 'path';
import fs from 'fs';

// Parse arguments
const args = process.argv.slice(2);
const spec = args.find(arg => !arg.startsWith('--'));
const skipE2E = args.includes('--skip-e2e');
const skipAPI = args.includes('--skip-api');
const skipK6 = args.includes('--skip-k6');
const skipZAP = args.includes('--skip-zap');
const vus = args.find(arg => arg.startsWith('--vus='))?.split('=')[1] || '10';
const duration = args.find(arg => arg.startsWith('--duration='))?.split('=')[1] || '30s';

const startTime = Date.now();

console.log(`
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                           โ
โ   โโโโโโโโโโโโโโโ โโโโโโโโโโ  โโโโโโ โโโโโโโโโ โโโโโโ                     โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                    โ
โ   โโโโโโ  โโโโโโโโโโโโโโ  โโโโโโโโโโโ   โโโ   โโโโโโโโ                    โ
โ   โโโโโโ  โโโโโโโ โโโโโโ  โโโโโโโโโโโ   โโโ   โโโโโโโโ                    โ
โ   โโโโโโโโโโโ     โโโโโโโโโโโโโโ  โโโ   โโโ   โโโ  โโโ                    โ
โ   โโโโโโโโโโโ     โโโโโโโโโโ โโโ  โโโ   โโโ   โโโ  โโโ                    โ
โ                                                                           โ
โ               QA AUTOMATION FRAMEWORK - FULL PIPELINE                     โ
โ                                                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
`);

const steps = [
    { name: 'E2E', enabled: !skipE2E, icon: '๐ญ' },
    { name: 'API', enabled: !skipAPI, icon: '๐ก' },
    { name: 'K6', enabled: !skipK6, icon: 'โก' },
    { name: 'ZAP', enabled: !skipZAP, icon: '๐' },
];

console.log('  Pipeline Configuration:');
steps.forEach(s => console.log(`    ${s.icon} ${s.name}: ${s.enabled ? 'ENABLED' : 'SKIP'}`));
console.log('');

const results = [];

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// STEP 1: E2E TESTS
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if (!skipE2E) {
    console.log('');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('โ  STEP 1/4: E2E TESTS (Playwright + Allure)                               โ');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

    try {
        let cmd = 'node scripts/run-e2e.mjs --capture-api';
        if (spec) cmd += ` ${spec}`;
        execSync(cmd, { stdio: 'inherit' });
        results.push({ step: 'E2E', status: 'PASS' });
    } catch {
        results.push({ step: 'E2E', status: 'FAIL' });
        console.error('  E2E Tests fallaron, continuando...');
    }
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// STEP 2: API TESTS
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if (!skipAPI) {
    console.log('');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('โ  STEP 2/4: API TESTS (Newman + HTMLExtra)                                โ');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

    try {
        execSync('node scripts/run-api.mjs', { stdio: 'inherit' });
        results.push({ step: 'API', status: 'PASS' });
    } catch {
        results.push({ step: 'API', status: 'FAIL' });
        console.error('  API Tests fallaron, continuando...');
    }
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// STEP 3: PERFORMANCE TESTS
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if (!skipK6) {
    console.log('');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('โ  STEP 3/4: PERFORMANCE TESTS (K6 + HTML Report)                          โ');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

    try {
        execSync(`node scripts/run-k6.mjs --vus=${vus} --duration=${duration}`, { stdio: 'inherit' });
        results.push({ step: 'K6', status: 'PASS' });
    } catch {
        results.push({ step: 'K6', status: 'FAIL' });
        console.error('  K6 Tests fallaron, continuando...');
    }
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// STEP 4: SECURITY TESTS
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if (!skipZAP) {
    console.log('');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('โ  STEP 4/4: SECURITY TESTS (OWASP ZAP + HTML Report)                      โ');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

    try {
        execSync('node scripts/run-zap.mjs', { stdio: 'inherit' });
        results.push({ step: 'ZAP', status: 'PASS' });
    } catch {
        results.push({ step: 'ZAP', status: 'WARN' }); // ZAP retorna error si encuentra vulns
    }
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// SUMMARY
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

console.log('');
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
console.log('โ                         PIPELINE COMPLETADO                               โ');
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ');

results.forEach(r => {
    const icon = r.status === 'PASS' ? 'โ' : r.status === 'WARN' ? 'โ๏ธ' : 'โ';
    console.log(`โ  ${icon} ${r.step.padEnd(10)} ${r.status.padEnd(6)}                                            โ`);
});

console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ');
console.log(`โ  โฑ๏ธ  Tiempo total: ${elapsed}s                                              โ`);
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ');
console.log('โ                                                                           โ');
console.log('โ  ๐ REPORTES:                                                             โ');
console.log('โ     reports/e2e/allure-report/   - Allure HTML                           โ');
console.log('โ     reports/api/                  - Newman HTMLExtra                      โ');
console.log('โ     reports/k6/                   - K6 HTML + Grafana                     โ');
console.log('โ     reports/zap/                  - ZAP HTML + JSON                       โ');
console.log('โ                                                                           โ');
console.log('โ  ๐ DASHBOARDS:                                                           โ');
console.log('โ     Grafana:  http://localhost:3001                                       โ');
console.log('โ     Allure:   http://localhost:5050                                       โ');
console.log('โ     ZAP GUI:  http://localhost:8082                                       โ');
console.log('โ                                                                           โ');
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
