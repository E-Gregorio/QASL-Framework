# =============================================================================
# SIGMA QA Framework - GitLab CI/CD Pipeline
# =============================================================================
# Pipeline automÃ¡tico que ejecuta todas las pruebas y publica reportes
#
# Configurar Schedule en GitLab: Settings > CI/CD > Schedules
#   - DescripciÃ³n: "EjecuciÃ³n Diaria QA"
#   - Interval: 0 8 * * 1-5 (Lunes a Viernes 8:00 AM)
#   - Target branch: main
#
# Variables requeridas en GitLab (Settings > CI/CD > Variables):
#   - INFLUX_URL: URL de InfluxDB (ej: http://tu-servidor:8086)
#   - SMTP_SERVER: Servidor SMTP para emails
#   - SMTP_USER: Usuario SMTP
#   - SMTP_PASSWORD: Password SMTP
#   - NOTIFICATION_EMAILS: Emails separados por coma
#
# Reportes disponibles en GitLab Pages:
#   - https://<grupo>.gitlab.io/<proyecto>/allure/
#   - https://<grupo>.gitlab.io/<proyecto>/api/
#   - https://<grupo>.gitlab.io/<proyecto>/k6/
#   - https://<grupo>.gitlab.io/<proyecto>/zap/
# =============================================================================

stages:
  - setup
  - test
  - metrics
  - report
  - notify

variables:
  NODE_VERSION: "18"
  # URLs de InfluxDB (configurar en GitLab CI/CD Variables)
  INFLUX_URL: ${INFLUX_URL:-"http://localhost:8086"}
  INFLUX_DB: "k6"

# =============================================================================
# SETUP - InstalaciÃ³n de dependencias
# =============================================================================
setup:
  stage: setup
  image: node:18
  script:
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "  SIGMA QA - Instalando dependencias..."
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - npm ci
    - npx playwright install --with-deps chromium
    - echo "âœ… Dependencias instaladas"
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - ~/.cache/ms-playwright/

# =============================================================================
# E2E TESTS - Playwright + Allure
# =============================================================================
e2e-tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.40.0-jammy
  needs: ["setup"]
  script:
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "  ğŸ§ª PRUEBAS E2E - Playwright"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - npm ci
    - mkdir -p allure-results reports/e2e public/allure
    - npx playwright test --reporter=line,allure-playwright || true
    - echo ""
    - echo "ğŸ“Š Generando reporte Allure..."
    - npx allure generate allure-results -o public/allure --clean || true
    - cp -r allure-results reports/e2e/ || true
    - echo "âœ… E2E completado"
  artifacts:
    when: always
    paths:
      - allure-results/
      - reports/e2e/
      - public/allure/
    expire_in: 30 days
  allow_failure: true

# =============================================================================
# API TESTS - Newman + HTMLExtra
# =============================================================================
api-tests:
  stage: test
  image: node:18
  needs: ["setup"]
  script:
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "  ğŸ”Œ PRUEBAS API - Newman"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - npm ci
    - mkdir -p reports/api public/api
    - |
      if [ -d ".api-captures" ] && [ "$(ls -A .api-captures 2>/dev/null)" ]; then
        npm run api || true
        cp reports/api/*.html public/api/ 2>/dev/null || true
        cp reports/api/*.json public/api/ 2>/dev/null || true
      else
        echo "âš ï¸ No hay capturas de API. Ejecutar E2E con --capture-api primero."
      fi
    - echo "âœ… API completado"
  artifacts:
    when: always
    paths:
      - reports/api/
      - public/api/
    expire_in: 30 days
  allow_failure: true

# =============================================================================
# K6 TESTS - Performance
# =============================================================================
k6-tests:
  stage: test
  image: grafana/k6:latest
  needs: []
  script:
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "  âš¡ PRUEBAS PERFORMANCE - K6"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - mkdir -p reports/k6 public/k6
    - |
      if [ -d ".api-captures" ] && [ "$(ls -A .api-captures 2>/dev/null)" ]; then
        # K6 con output a InfluxDB si estÃ¡ configurado
        if [ -n "$INFLUX_URL" ]; then
          k6 run --out influxdb=${INFLUX_URL}/${INFLUX_DB} \
                 --out json=reports/k6/results.json \
                 .temp-k6/performance.js || true
        else
          k6 run --out json=reports/k6/results.json \
                 .temp-k6/performance.js || true
        fi
        cp reports/k6/*.html public/k6/ 2>/dev/null || true
        cp reports/k6/*.json public/k6/ 2>/dev/null || true
      else
        echo "âš ï¸ No hay capturas de API para K6."
      fi
    - echo "âœ… K6 completado"
  artifacts:
    when: always
    paths:
      - reports/k6/
      - public/k6/
    expire_in: 30 days
  allow_failure: true

# =============================================================================
# ZAP TESTS - Security (Solo en schedule o manual)
# =============================================================================
zap-tests:
  stage: test
  image: ghcr.io/zaproxy/zaproxy:stable
  needs: []
  script:
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "  ğŸ›¡ï¸ PRUEBAS SEGURIDAD - OWASP ZAP"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - mkdir -p reports/zap public/zap
    - |
      if [ -d ".api-captures" ] && [ "$(ls -A .api-captures 2>/dev/null)" ]; then
        # Obtener URL del primer archivo de captura
        CAPTURE_FILE=$(ls -t .api-captures/*-apis.json 2>/dev/null | head -1)
        if [ -f "$CAPTURE_FILE" ]; then
          TARGET_URL=$(cat "$CAPTURE_FILE" | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['url'].split('/')[0]+'//'+json.load(sys.stdin)[0]['url'].split('/')[2])" 2>/dev/null || echo "")
          if [ -n "$TARGET_URL" ]; then
            echo "Target: $TARGET_URL"
            zap-baseline.py -t "$TARGET_URL" \
                           -r reports/zap/zap-report.html \
                           -J reports/zap/zap-report.json \
                           -a -j || true
            cp reports/zap/*.html public/zap/ 2>/dev/null || true
            cp reports/zap/*.json public/zap/ 2>/dev/null || true
          fi
        fi
      else
        echo "âš ï¸ No hay capturas de API para ZAP."
      fi
    - echo "âœ… ZAP completado"
  artifacts:
    when: always
    paths:
      - reports/zap/
      - public/zap/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - when: manual
  allow_failure: true

# =============================================================================
# METRICS - Enviar mÃ©tricas a InfluxDB/Grafana
# =============================================================================
send-metrics:
  stage: metrics
  image: node:18
  needs: ["e2e-tests", "api-tests"]
  script:
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "  ğŸ“Š Enviando mÃ©tricas a Grafana..."
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - npm ci
    - |
      if [ -n "$INFLUX_URL" ]; then
        export INFLUX_URL=$INFLUX_URL
        export INFLUX_DB=$INFLUX_DB
        node scripts_metricas/send-e2e-metrics.mjs || true
        node scripts_metricas/send-api-metrics.mjs || true
        node scripts_metricas/send-zap-metrics.mjs || true
        echo "âœ… MÃ©tricas enviadas a Grafana"
      else
        echo "âš ï¸ INFLUX_URL no configurado. MÃ©tricas no enviadas."
      fi
  allow_failure: true

# =============================================================================
# PAGES - Publicar TODOS los reportes en GitLab Pages
# =============================================================================
pages:
  stage: report
  image: alpine:latest
  needs: ["e2e-tests", "api-tests", "k6-tests", "zap-tests"]
  script:
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "  Publicando reportes en GitLab Pages..."
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - mkdir -p public/allure public/api public/k6 public/zap
    - cp -r allure-results/* public/allure/ 2>/dev/null || echo "No allure results"
    - cp reports/api/*.html public/api/ 2>/dev/null || echo "No API reports"
    - cp reports/api/*.json public/api/ 2>/dev/null || true
    - cp reports/k6/*.html public/k6/ 2>/dev/null || echo "No K6 reports"
    - cp reports/k6/*.json public/k6/ 2>/dev/null || true
    - cp reports/zap/*.html public/zap/ 2>/dev/null || echo "No ZAP reports"
    - cp reports/zap/*.json public/zap/ 2>/dev/null || true
    - echo "<!DOCTYPE html><html lang='es'><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width,initial-scale=1.0'><title>SIGMA QA - Reportes</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);min-height:100vh;color:#fff;padding:40px 20px}.container{max-width:800px;margin:0 auto}h1{text-align:center;font-size:2.5rem;margin-bottom:10px;color:#00d4ff}.subtitle{text-align:center;color:#888;margin-bottom:40px}.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}.card{background:rgba(255,255,255,0.05);border-radius:15px;padding:30px;text-decoration:none;color:#fff;transition:all 0.3s ease;border:1px solid rgba(255,255,255,0.1)}.card:hover{transform:translateY(-5px);background:rgba(255,255,255,0.1);border-color:#00d4ff}.card-icon{font-size:3rem;margin-bottom:15px}.card-title{font-size:1.3rem;font-weight:bold;margin-bottom:10px}.card-desc{color:#aaa;font-size:0.9rem}.e2e{border-left:4px solid #4ade80}.api{border-left:4px solid #60a5fa}.k6{border-left:4px solid #a78bfa}.zap{border-left:4px solid #f87171}.footer{text-align:center;margin-top:40px;color:#666;font-size:0.85rem}</style></head><body><div class='container'><h1>SIGMA QA - Reportes</h1><p class='subtitle'>EPIDATA Consulting | Proyecto SIGMA | Lider Tecnico: Elyer Maldonado</p><div class='cards'><a href='allure/index.html' class='card e2e'><div class='card-icon'>E2E</div><div class='card-title'>E2E Tests (Allure)</div><div class='card-desc'>Pruebas end-to-end con Playwright. Incluye screenshots, videos y trazabilidad.</div></a><a href='api/' class='card api'><div class='card-icon'>API</div><div class='card-title'>API Tests (Newman)</div><div class='card-desc'>Pruebas de API con Newman HTMLExtra. Validacion de endpoints y responses.</div></a><a href='k6/' class='card k6'><div class='card-icon'>K6</div><div class='card-title'>Performance (K6)</div><div class='card-desc'>Pruebas de carga y rendimiento. Metricas de response time y throughput.</div></a><a href='zap/' class='card zap'><div class='card-icon'>ZAP</div><div class='card-title'>Security (OWASP ZAP)</div><div class='card-desc'>Analisis de seguridad. Vulnerabilidades clasificadas por severidad.</div></a></div><p class='footer'>EPIDATA - Proyecto SIGMA | TeamQA</p></div></body></html>" > public/index.html
    - echo "Reportes publicados en GitLab Pages"
  artifacts:
    paths:
      - public/
    expire_in: 30 days

# =============================================================================
# NOTIFY SUCCESS - Enviar email con resumen y links
# =============================================================================
notify-success:
  stage: notify
  image: alpine:latest
  needs: ["pages", "send-metrics"]
  script:
    - apk add --no-cache curl jq
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "  ğŸ“§ Enviando notificaciÃ³n de Ã©xito..."
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - |
      # Extraer mÃ©tricas de los reportes
      E2E_PASSED=0
      E2E_FAILED=0
      API_PASSED=0
      API_FAILED=0
      ZAP_HIGH=0
      ZAP_MEDIUM=0
      ZAP_LOW=0

      # Leer mÃ©tricas de E2E (allure)
      if [ -d "allure-results" ]; then
        E2E_PASSED=$(ls -1 allure-results/*-result.json 2>/dev/null | xargs grep -l '"status":"passed"' 2>/dev/null | wc -l || echo 0)
        E2E_FAILED=$(ls -1 allure-results/*-result.json 2>/dev/null | xargs grep -l '"status":"failed"' 2>/dev/null | wc -l || echo 0)
      fi

      # Leer mÃ©tricas de ZAP
      if [ -f "reports/zap/zap-report.json" ]; then
        ZAP_HIGH=$(cat reports/zap/zap-report.json | jq '[.site[].alerts[] | select(.riskcode=="3")] | length' 2>/dev/null || echo 0)
        ZAP_MEDIUM=$(cat reports/zap/zap-report.json | jq '[.site[].alerts[] | select(.riskcode=="2")] | length' 2>/dev/null || echo 0)
        ZAP_LOW=$(cat reports/zap/zap-report.json | jq '[.site[].alerts[] | select(.riskcode=="1")] | length' 2>/dev/null || echo 0)
      fi

      E2E_TOTAL=$((E2E_PASSED + E2E_FAILED))
      if [ $E2E_TOTAL -gt 0 ]; then
        E2E_RATE=$((E2E_PASSED * 100 / E2E_TOTAL))
      else
        E2E_RATE=0
      fi

      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  ğŸš€ SIGMA QA - Pipeline Completado"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      echo "  ğŸ“… Fecha:    $(date '+%Y-%m-%d %H:%M')"
      echo "  ğŸ”€ Branch:   ${CI_COMMIT_REF_NAME}"
      echo "  ğŸ·ï¸  Pipeline: #${CI_PIPELINE_ID}"
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  ğŸ“Š RESUMEN"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      echo "  ğŸ§ª E2E:  ${E2E_RATE}% (${E2E_PASSED}/${E2E_TOTAL} passed)"
      echo "  ğŸ›¡ï¸  ZAP:  ${ZAP_HIGH} High | ${ZAP_MEDIUM} Medium | ${ZAP_LOW} Low"
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  ğŸ“ REPORTES"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      echo "  ğŸ“‹ Index:   ${CI_PAGES_URL}"
      echo "  ğŸ§ª Allure:  ${CI_PAGES_URL}/allure"
      echo "  ğŸ”Œ API:     ${CI_PAGES_URL}/api"
      echo "  âš¡ K6:      ${CI_PAGES_URL}/k6"
      echo "  ğŸ›¡ï¸  ZAP:     ${CI_PAGES_URL}/zap"
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  EPIDATA - Proyecto SIGMA | TeamQA"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  when: on_success

# =============================================================================
# NOTIFY FAILURE - Notificar errores
# =============================================================================
notify-failure:
  stage: notify
  image: alpine:latest
  needs: ["e2e-tests", "api-tests"]
  script:
    - |
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  âš ï¸ SIGMA QA - Pipeline FALLIDO"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      echo "  ğŸ“… Fecha:    $(date '+%Y-%m-%d %H:%M')"
      echo "  ğŸ”€ Branch:   ${CI_COMMIT_REF_NAME}"
      echo "  ğŸ·ï¸  Pipeline: #${CI_PIPELINE_ID}"
      echo ""
      echo "  ğŸ” Ver logs: ${CI_PIPELINE_URL}"
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  when: on_failure
