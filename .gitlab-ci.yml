stages:
  - static-analysis
  - test
  - report
  - deploy

variables:
  PLAYWRIGHT_BROWSERS_PATH: 0

cache:
  paths:
    - node_modules/

before_script:
  - npm ci
  - npx playwright install --with-deps

static-analysis:
  stage: static-analysis
  script:
    - echo "Running static analysis..."
    - npm run lint || true
  artifacts:
    paths:
      - static-analysis/
    expire_in: 1 week

test:smoke:
  stage: test
  script:
    - npm run test:smoke
  artifacts:
    when: always
    paths:
      - reports/
    expire_in: 1 week
  only:
    - merge_requests
    - main

test:regression:
  stage: test
  script:
    - npm run test:regression
  artifacts:
    when: always
    paths:
      - reports/
    expire_in: 1 week
  only:
    - main
    - develop

test:e2e:
  stage: test
  script:
    - npm run test:e2e
  artifacts:
    when: always
    paths:
      - reports/
    expire_in: 1 week
  allow_failure: true

generate:allure:
  stage: report
  script:
    - npm run report:allure
  artifacts:
    paths:
      - reports/allure/allure-report/
    expire_in: 1 month
  dependencies:
    - test:smoke
    - test:regression
    - test:e2e

pages:
  stage: deploy
  script:
    - mkdir -p public
    - cp -r reports/allure/allure-report/* public/
  artifacts:
    paths:
      - public
  only:
    - main
