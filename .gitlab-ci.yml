stages:
  - build
  - test
  - report

image: node:18

variables:
  PLAYWRIGHT_BROWSERS_PATH: 0

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

# ============================================
# BUILD
# ============================================
install:
  stage: build
  script:
    - npm install
    - npx playwright install --with-deps chromium
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# ============================================
# TEST - Solo se ejecuta manualmente o en MR
# ============================================
test:e2e:
  stage: test
  needs: [install]
  script:
    - npm run e2e -- --capture-api
  artifacts:
    when: always
    paths:
      - reports/
      - .api-captures/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - when: manual

test:api:
  stage: test
  needs: [test:e2e]
  script:
    - npm run api
  artifacts:
    when: always
    paths:
      - reports/api/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: manual
  allow_failure: true

# ============================================
# REPORT - Genera Allure Report
# ============================================
generate:allure:
  stage: report
  needs: [test:e2e]
  script:
    - npm run allure:generate
  artifacts:
    paths:
      - reports/e2e/allure-report/
    expire_in: 1 month
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: manual

# ============================================
# PAGES - Publica reporte en GitLab Pages
# ============================================
pages:
  stage: report
  needs: [generate:allure]
  script:
    - mkdir -p public
    - cp -r reports/e2e/allure-report/* public/ || echo "No allure report"
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
