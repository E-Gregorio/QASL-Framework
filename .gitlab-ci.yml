# SIGMA QA Framework - GitLab CI/CD Pipeline
stages:
  - test
  - deploy

# E2E TESTS
e2e-tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.40.0-jammy
  script:
    - npm ci
    - npm install -g allure-commandline
    - mkdir -p allure-results
    - npx playwright test --reporter=line,allure-playwright || true
    - npx allure generate allure-results -o allure-report --clean || true
  artifacts:
    when: always
    paths:
      - allure-results/
      - allure-report/
    expire_in: 30 days

# API TESTS
api-tests:
  stage: test
  image: node:18
  script:
    - npm ci
    - mkdir -p reports/api
    - echo "<html><body><h1>API Tests</h1><p>Sin capturas</p></body></html>" > reports/api/index.html
  artifacts:
    when: always
    paths:
      - reports/api/
    expire_in: 30 days
  allow_failure: true

# PAGES
pages:
  stage: deploy
  image: alpine:latest
  needs:
    - job: e2e-tests
      artifacts: true
    - job: api-tests
      artifacts: true
  script:
    - mkdir -p public/allure public/api
    - cp -r allure-report/* public/allure/ || true
    - cp -r reports/api/* public/api/ || true
    - echo "<html><head><title>SIGMA QA</title><style>body{font-family:Arial;background:#1a1a2e;color:white;padding:40px;text-align:center}h1{color:#00d4ff}a{color:#4ade80;font-size:1.2rem}</style></head><body><h1>SIGMA QA - Reportes</h1><p>EPIDATA - Elyer Maldonado</p><br><a href=allure/index.html>E2E Tests - Allure</a><br><br><a href=api/index.html>API Tests - Newman</a></body></html>" > public/index.html
  artifacts:
    paths:
      - public/
    expire_in: 30 days
